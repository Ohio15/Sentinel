# Sentinel RMM - Project Guidelines

## Development Philosophy

**Autonomous Decision Making**: Make implementation decisions independently using:
- Industry best practices for RMM/MSP software
- Security-first approach (input validation, secure communications, least privilege)
- Professional UX patterns from tools like ConnectWise, Datto, NinjaRMM
- Clean code principles and maintainable architecture

**When to proceed without asking:**
- Implementation approach choices (use best practice)
- Version bumps when releasing features/fixes
- Building, committing, and creating GitHub releases after changes
- Adding error handling, validation, logging
- UI/UX improvements that follow standard patterns
- Bug fixes and their associated version updates

**Only ask when:**
- Major architectural changes that affect the entire system
- Removing existing features
- Changes that could break backward compatibility
- Unclear or ambiguous user requirements

---

## Version Files (MUST Stay in Sync)

| File | Purpose |
|------|---------|
| `package.json` | Electron app version |
| `agent/version.json` | **Docker backend reads this** - agents check for updates here |
| `release/agent/version.json` | Bundled in Electron installer |
| `release/app/latest.yml` | Electron auto-updater manifest (auto-generated by build) |

**Critical:** `agent/version.json` is volume-mounted into Docker. If this falls behind, agents won't see updates.

---

## Architecture

```
Electron App
    └── Local API server for UI
    └── Bundles agent binaries in resources/agent/

Docker Backend (localhost:8081)
    └── Container: sentinel-backend
    └── Agent API: /api/agent/version, /api/agent/update/download
    └── Volume mounts:
        - ./installers:/app/installers:ro
        - ./agent/version.json:/app/agent/version.json:ro

Agent Binaries:
    └── release/agent/sentinel-agent.exe (bundled with installer)
    └── release/agent/sentinel-watchdog.exe
    └── installers/ (served by Docker for remote downloads)
```

---

## Key Paths

| Item | Path |
|------|------|
| Agent Go source | `agent/cmd/sentinel-agent/` |
| Watchdog Go source | `agent/cmd/sentinel-watchdog/` |
| Go backend server | `server/internal/api/` |
| Electron main process | `src/main/main.ts` |
| Frontend React | `src/renderer/` |
| Database migrations | `src/main/migrations/` |
| Release installers | `release/app/` |
| Release agent binaries | `release/agent/` |

---

## Build Commands

```bash
# Electron Windows installer
npm run dist:win

# Agent binaries (run from agent/ directory)
"/c/Program Files/Go/bin/go.exe" build -ldflags "-X main.Version=X.X.X" -o ../release/agent/sentinel-agent.exe ./cmd/sentinel-agent
"/c/Program Files/Go/bin/go.exe" build -ldflags "-X main.Version=X.X.X" -o ../release/agent/sentinel-watchdog.exe ./cmd/sentinel-watchdog

# After updating agent/version.json
docker restart sentinel-backend
```

---

## Version Bump Checklist

When releasing a new version:

1. Update `package.json` version
2. Update `agent/version.json` (version, releaseDate, changelog)
3. Build agent binaries with matching `-ldflags "-X main.Version=X.X.X"`
4. Copy binaries to `release/agent/`
5. **Copy binaries to `installers/` for Docker auto-update downloads**
   - `cp release/agent/sentinel-agent.exe installers/sentinel-agent-windows-amd64.exe`
6. Update `release/agent/version.json`
7. Run `npm run dist:win`
8. **Restart Docker:** `docker restart sentinel-backend`
9. Commit all version files
10. Push to GitHub
11. Create GitHub release with installer

---

## API Endpoints (Docker :8081)

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/api/agent/version?current=X.X.X&platform=windows&arch=amd64` | GET | Check for updates |
| `/api/agent/update/download?platform=windows&arch=amd64` | GET | Download agent binary |
| `/api/devices` | GET | List registered devices |
| `/api/devices/:id` | GET | Get device details |
| `/api/auth/login` | POST | Authentication |

---

## Caching Behavior

- **Go backend caches version.json for 60 seconds** - restart container or wait after updates
- **Fallback version is "1.12.0"** if version.json cannot be read (`server/internal/api/agent_updates.go:76`)

---

## GitHub

- **Repository:** `Ohio15/Sentinel`
- **Auto-publish:** Configured in `package.json` under `build.publish`

---

## Common Issues

### Agent not seeing updates
1. Check `agent/version.json` has correct version
2. Restart Docker: `docker restart sentinel-backend`
3. Verify API: `curl "http://localhost:8081/api/agent/version?current=1.0.0&platform=windows&arch=amd64"`

### Device shows offline but agent is running
- Check `src/main/main.ts` - `devices:list` and `devices:get` handlers override status based on WebSocket connection
- Verify `agentManager.isAgentConnected(device.agentId)` returns correct state

---

## Electron Auto-Updater

The auto-updater uses `electron-updater` and checks GitHub releases.

### Setup
- Config in `src/main/main.ts` lines 45-138
- Publish config in `package.json` → `build.publish`
- For private repos: Set `GH_TOKEN` env var or create `update-config.json` with `githubToken`

### Creating a GitHub Release (REQUIRED for auto-updater)
```bash
gh release create v{version} \
  "release/app/Sentinel-Setup-{version}.exe" \
  "release/app/Sentinel-Setup-{version}.exe.blockmap" \
  "release/app/latest.yml" \
  --title "v{version} - Title" \
  --notes "Release notes..."
```

**IMPORTANT**: Without a GitHub release containing these 3 files, the auto-updater will NOT detect updates!

---

## WebSocket Message Types

Defined in `agent/internal/client/client.go` and `src/main/agents.ts`:

| Type | Direction | Purpose |
|------|-----------|---------|
| `ping` | Server → Agent | Check connectivity |
| `pong` | Agent → Server | Response to ping |
| `heartbeat` | Agent → Server | Keepalive (30s interval) |
| `metrics` | Agent → Server | System metrics |
| `command` | Server → Agent | Execute remote command |
| `command_result` | Agent → Server | Command output |

---

## Electron IPC Channels

| Channel | Purpose |
|---------|---------|
| `devices:ping` | Ping agent to check connectivity |
| `devices:list` | Get all devices |
| `devices:get` | Get single device by ID |
| `devices:update` | Update device properties |
| `commands:execute` | Execute command on agent |
| `commands:getHistory` | Get command history for device |
